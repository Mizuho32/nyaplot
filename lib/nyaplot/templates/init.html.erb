<script>
if(window['d3'] === undefined ||
   window['Nyaplot'] === undefined){
    var path = <%= dep_libraries.to_json %>;

    var shim = {
    'd3': {exports: 'd3'},
	'THREE': {exports: 'THREE'},
    'Elegans': {exports: 'Elegans'}
    };

    require.config({paths: path, shim:shim});

<%
str=""
dep_libraries.each do |key, val|
  str.concat("require(['%s'], function(%s){window['%s']=%s;console.log('finished loading %s');"% Array.new(5, key))
end
%>
<%= str %>

	var script = d3.select("head")
	    .append("script")
	    .attr("src", "https://rawgit.com/domitry/Nyaplotjs/master/release/nyaplot.js")
	    .attr("async", true);

	script[0][0].onload = script[0][0].onreadystatechange = function(){
	    var event = document.createEvent("HTMLEvents");
	    event.initEvent("load_nyaplot",false,false);
	    window.dispatchEvent(event);
	    console.log('Finished loading Nyaplotjs');
	};

<%
 str = Array.new(dep_libraries.length, "});").join("")
%>
<%= str %>
}
</script>
